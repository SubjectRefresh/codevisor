<!--
    (c) 2015 Finnian Anderson. All rights reserved.
-->
<!DOCTYPE HTML>
<html>

<head>
    <title>CodeVisor</title>
    <link rel="stylesheet" type="text/css" href="common/css/codevisor.css">
    <link id="theme" rel="stylesheet" type="text/css">
</head>

<body>
    <div class="video" style="">
        <video muted autoplay loop>
            <source src="common/img/example.mp4" type="video/mp4"> Your browser does not support the video tag.
        </video>
    </div>
    <div class="home" style="">
        <div class="input-container">
            <input id="url" type="text" size="10" value="github.com/subjectrefresh/codevisor" placeholder="github.com/x/y" title="Repository" autofocus>
        </div>
    </div>
    <div class="repo-page">
        <div class="container">
            <div id="video-pane">
                <container></container>
            </div>
            <div id="sidebar"></div>
            <div id="contributors"></div>
        </div>
    </div>
    <script async src="common/js/socket.io.js"></script>
    <script async src="common/js/notification/notification.min.js"></script>
    <script src="common/js/jquery.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript">
    var urlRegExp = /^((ht|f)tps?:\/\/|)[a-z0-9-\.]+\.[a-z]{2,4}\/?([^\s<>\#%"\,\{\}\\|\\\^\[\]`]+)?$/;
    var socket;
    $(function() {
        if (Notification.permission !== 'granted') {
            Notification.requestPermission();
        }
        $("#url").keyup(function(e) {
            if (e.keyCode == 13) {
                socket.emit("get heads", {
                    url: $(this).val()
                });
            }
            if (e.keyCode >= 48 && e.keyCode <= 90 && e.keyCode != 32) {
                if (urlRegExp.test($(this).val())) {
                    $(this).addClass("valid").removeClass("invalid");
                } else {
                    $(this).addClass("invalid").removeClass("valid");
                }
            }
        }).blur(function() {
            if ($(this).val().replace(" ", "") == "") {
                $(this).removeClass("valid").removeClass("invalid");
            }
        });
        $.getJSON("get_config", function(config) {
            socket = io(config.socket);

            // socket.emit("repo page", { // for development
            //     head: "master",
            //     owner: "subjectrefresh",
            //     repo: "codevisor"
            // });

            if (config.google_analytics) {
                (function(i, s, o, g, r, a, m) {
                    i['GoogleAnalyticsObject'] = r;
                    i[r] = i[r] || function() {
                        (i[r].q = i[r].q || []).push(arguments)
                    }, i[r].l = 1 * new Date();
                    a = s.createElement(o),
                        m = s.getElementsByTagName(o)[0];
                    a.async = 1;
                    a.src = g;
                    m.parentNode.insertBefore(a, m)
                })(window, document, 'script', 'http://www.google-analytics.com/analytics.js', 'ga');

                ga('create', 'UA-69122586-1', 'auto');
                ga('send', 'pageview');
                ga('_setDomainName', 'subjectrefresh.info');
            }

            socket.on("e", function(packet) {
                if (packet.message == "Invalid URL") {
                    console.log("Invalid URL");
                    $("#url").removeClass("valid").addClass("invalid");
                }
            });

            socket.on("head list", function(packet) {
                if (packet.status) {
                    $("#url").fadeOut("slow", function() {
                        $("<select id='head' data-owner='" + packet.owner + "' data-repo='" + packet.repo + "'></select>").appendTo($(".input-container"));
                        for (var i = 0; i < packet.heads.length; i++) {
                            $("<option value='" + packet.heads[i].ref + "'>" + packet.heads[i].ref.split("/")[2] + "</option>").appendTo($("#head"));
                        }
                        $("<button class='submit'>Go!</button>").appendTo($(".input-container")).on("click", function() {
                            socket.emit("repo page", {
                                head: $("#head").val(),
                                owner: $("#head").data("owner"),
                                repo: $("#head").data("repo")
                            });
                        });
                    });
                } else {
                    alert("Error: " + packet.message);
                }
            });
            var doNotChangeURL = true;
            socket.on("repo page", function(packet) {
                console.log(packet);
                if (typeof doNotChangeURL === 'undefined') history.pushState('data', '', packet.url);
                $(".video").addClass("scale-5-5");
                $(".home").addClass("scale-5-5");
                $("body").css("background-color", "#212121");
                $("#theme").attr("href", "common/css/themes/" + packet.theme + ".css");
                setTimeout(function() {
                    $(".repo-page").addClass("slide-down").show();
                    for (var i = 0; i < packet.contributors.length; i++) {
                        $("<span class='contributor'><a href='" + packet.contributors[i].url + "'><img src='" + packet.contributors[i].icon + "'></a></span>").appendTo($("#contributors"));
                    }
                    for (var i = 0; i < packet.commits.length; i++) {
                        $("<div class='commit'><span class='author'><img src='" + packet.commits[i].author.icon + "'></span><span class='message'>" + packet.commits[i].message + "</span><span class='when'>" + packet.commits[i].author.date + "</span></div>").appendTo($("#sidebar"));
                    }
                    var nodes = flatten(packet.tree);
                    var links = d3.layout.tree().links(nodes);
                    var tooltip = d3.select("body").append("div")
                        .attr("class", "tooltip card")
                        .style("opacity", 0);
                    force
                        .nodes(nodes)
                        .links(links)
                        .start();

                    var link = svg.selectAll(".link")
                        .data(links)
                        .enter().append("line")
                        .attr("class", "link")
                        .style("stroke-width", function(d) {
                            return Math.sqrt(d.value);
                        });

                    var node = svg.selectAll(".node")
                        .data(nodes)
                        .enter().append("circle")
                        .attr("class", "node")
                        .attr("r", 5)
                        .style("fill", function(d) {
                            return color(d.color);
                        })
                        .on("mouseover", function(d) {
                            tooltip.transition()
                                .duration(100)
                                .style("opacity", .8);
                            tooltip.html(d.name)
                                .style("left", d.x + "px")
                                .style("top", d.y + "px");
                        })
                        .on("mouseout", function(d) {
                            tooltip.transition()
                                .duration(0)
                                .style("opacity", 0);
                        })
                        .on("mousedown", function(d) {
                            tooltip.transition()
                                .duration(400)
                                .style("opacity", 0);
                        })
                        .call(force.drag);

                    node.append("title")
                        .text(function(d) {
                            return d.name;
                        });

                    force.on("tick", function() {
                        link.attr("x1", function(d) {
                                return d.source.x;
                            })
                            .attr("y1", function(d) {
                                return d.source.y;
                            })
                            .attr("x2", function(d) {
                                return d.target.x;
                            })
                            .attr("y2", function(d) {
                                return d.target.y;
                            });

                        node.attr("cx", function(d) {
                                return d.x;
                            })
                            .attr("cy", function(d) {
                                return d.y;
                            });
                    });
                }, 50);
            });
            socket.on("commits", function(packet) {
                var authors = [];
                if (packet.commits.length > 1) {
                    var title = "New commits";
                    var suffix = "commits";
                } else {
                    var title = "New commit";
                    var suffix = "commit";
                }
                for (var i = 0; i < packet.commits.length; i++){
                    authors.push(packet.commits[i].committer.name);
                }
                var body = authors.join(", ") + " pushed " + packet.commits.length + " " + suffix + " to " + packet.repository.full_name;
                n = new Notification(title, {
                    body: body,
                    icon: "common/img/codevisor.img"
                });
                // code to update force graph goes here.
                // packet.commits is the array of commits
            });
        });
    });
    var width = 960,
        height = 500;

    var color = d3.scale.category20();

    var force = d3.layout.force()
        .charge(-120)
        .linkDistance(30)
        .size([width, height]);

    var svg = d3.select("container").append("svg")
        .attr("width", width)
        .attr("height", height);

    function flatten(root) {
        var nodes = [],
            i = 0;

        function recurse(node) {
            if (node.children) node.children.forEach(recurse);
            if (!node.id) node.id = ++i;
            nodes.push(node);
        }

        recurse(root);
        return nodes;
    }
    </script>
</body>

</html>